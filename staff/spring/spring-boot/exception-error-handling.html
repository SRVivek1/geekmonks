<h1>Exception / Error Handling and Custom Exceptions</h1>

<p>
  Updated on: 
  
  
  
    - <a href="/geekmonks/authors/srvivek/">Vivek Singh</a>
  
</p>

<hr/>

<h3 id="project-ref-a2-sboot-ms-social-media-app">Project ref: <a href="https://github.com/SRVivek1/springboot-microservices-2024/tree/main/a2-sboot-ms-social-media-app">a2-sboot-ms-social-media-app</a></h3>
<ul>
  <li><strong><ins>Purpose / Feature</ins></strong>
    <ul>
      <li>Spring boot provides mechanism to handle and customize the exceptions thrown by the applications.</li>
    </ul>
  </li>
  <li><strong><ins>Maven / External dependency</ins></strong>
    <ul>
      <li>Add spring validation dependency.
 	```xml
	<dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency></li>
    </ul>
  </li>
  <li><strong><ins>Code changes</ins></strong>
    <ul>
      <li>Java Bean
        <ul>
          <li>Java Bean to standarized the error message returned to requestor/cient.</li>
          <li>ErrorDetails.java
            <ul>
              <li>imports
                <ul>
                  <li><code class="language-plaintext highlighter-rouge">None</code></li>
                </ul>
              </li>
              <li>Class with required properties
                <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ErrorDetails</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="nc">LocalDateTime</span> <span class="n">timestamp</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">message</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">details</span><span class="o">;</span>

        <span class="c1">// Constructor, setter-getters</span>
    <span class="o">}</span>
</code></pre></div>                </div>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>Custom Exception class
        <ul>
          <li>Create a custom exception class to determine the type of error that has occured.</li>
          <li>UserNotFoundException.java
            <ul>
              <li>imports
                <ul>
                  <li><code class="language-plaintext highlighter-rouge">import org.springframework.http.HttpStatus;</code></li>
                  <li><code class="language-plaintext highlighter-rouge">import org.springframework.web.bind.annotation.ResponseStatus;</code></li>
                </ul>
              </li>
              <li>Override required constructors and can have fields if any info need to be stored.
                <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@ResponseStatus</span><span class="o">(</span><span class="n">code</span> <span class="o">=</span> <span class="nc">HttpStatus</span><span class="o">.</span><span class="na">NOT_FOUND</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserNotFoundException</span> <span class="kd">extends</span> <span class="nc">RuntimeException</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">4882099180124262207L</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">UserNotFoundException</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div>                </div>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>Controller Advice class
        <ul>
          <li>Create a custom Controller advice class to determine the type of error that has occured.</li>
          <li>UserNotFoundException.java
            <ul>
              <li>imports
                <ul>
                  <li><code class="language-plaintext highlighter-rouge">import org.springframework.core.annotation.Order;</code></li>
                  <li><code class="language-plaintext highlighter-rouge">import org.springframework.http.HttpStatus;</code></li>
                  <li><code class="language-plaintext highlighter-rouge">import org.springframework.http.ResponseEntity;</code></li>
                  <li><code class="language-plaintext highlighter-rouge">import org.springframework.web.bind.annotation.ControllerAdvice;</code></li>
                  <li><code class="language-plaintext highlighter-rouge">import org.springframework.web.bind.annotation.ExceptionHandler;</code></li>
                  <li><code class="language-plaintext highlighter-rouge">import org.springframework.web.bind.annotation.RestControllerAdvice;</code></li>
                  <li><code class="language-plaintext highlighter-rouge">import org.springframework.web.context.request.WebRequest;</code></li>
                  <li><code class="language-plaintext highlighter-rouge">import org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler;</code></li>
                  <li><code class="language-plaintext highlighter-rouge">import jakarta.annotation.Priority;</code></li>
                </ul>
              </li>
              <li>Override required required method and process the exception.
                <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@ControllerAdvice</span>
    <span class="c1">//@ControllerAdvice(basePackages = "com.srvivek.x.y.z") //for specific package</span>
    <span class="c1">//@Order(value = 1) // for defining ordering</span>
    <span class="c1">//@Priority(value = 1) // for defining ordering</span>
    <span class="c1">//@RestControllerAdvice(basePackages = "com.srvivek.x.y.z") // @ControllerAdvice + @ResponseBody</span>
    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomizedResponseEntityExceptionHandler</span> <span class="kd">extends</span> <span class="nc">ResponseEntityExceptionHandler</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">CustomizedResponseEntityExceptionHandler</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="cm">/**
        * Generic exception handling.
        * @param ex
        * @param request
        * @return
        * @throws Exception
        */</span>
        <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="n">exception</span> <span class="o">=</span> <span class="nc">Exception</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">ErrorDetails</span><span class="o">&gt;</span> <span class="nf">handleAllException</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">,</span> <span class="nc">WebRequest</span> <span class="n">request</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Error stacktrace: {}"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>

            <span class="nc">ErrorDetails</span> <span class="n">errorDetails</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ErrorDetails</span><span class="o">(</span><span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">(),</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span>
                    <span class="n">request</span><span class="o">.</span><span class="na">getDescription</span><span class="o">(</span><span class="kc">false</span><span class="o">));</span>

            <span class="k">return</span> <span class="k">new</span> <span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">ErrorDetails</span><span class="o">&gt;(</span><span class="n">errorDetails</span><span class="o">,</span> <span class="nc">HttpStatus</span><span class="o">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="cm">/**
        * Return HTTP 404 for UserNotFoundException.
        * @param ex
        * @param request
        * @return
        * @throws Exception
        */</span>
        <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="n">exception</span> <span class="o">=</span> <span class="nc">UserNotFoundException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="kd">public</span> <span class="kd">final</span> <span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">ErrorDetails</span><span class="o">&gt;</span> <span class="nf">handleUserNotFoundException</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">,</span> <span class="nc">WebRequest</span> <span class="n">request</span><span class="o">)</span>
                <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Error stacktrace: {}"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>

            <span class="nc">ErrorDetails</span> <span class="n">errorDetails</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ErrorDetails</span><span class="o">(</span><span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">(),</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span>
                    <span class="n">request</span><span class="o">.</span><span class="na">getDescription</span><span class="o">(</span><span class="kc">false</span><span class="o">));</span>

            <span class="k">return</span> <span class="k">new</span> <span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">ErrorDetails</span><span class="o">&gt;(</span><span class="n">errorDetails</span><span class="o">,</span> <span class="nc">HttpStatus</span><span class="o">.</span><span class="na">NOT_FOUND</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div>                </div>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li><strong><ins>Notes:</ins></strong>
    <ul>
      <li>We can define controller advice for specific package.</li>
      <li>While handling exceptions, also log the error explicitly or else it will not be logged in log files.</li>
    </ul>
  </li>
</ul>


<!-- TODO: add footer -->